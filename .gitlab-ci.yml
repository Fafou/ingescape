# Gitlab ci

# TODO Check why with install target windows api are in bin subfolder
# TODO Check why with compile target zmq, ... are not copied in Release folder on windows
# TODO Add job to deploy ingescape website on commit (Can filter to launch job on doc folder changes and only master git's branche)
# TODO Add job to compile ingeprobe
# TODO Add job to package bindings

# Define job order
stages:
  - build-lib
  - installer-lib
  - build-apps
  - installer-apps
  - deploy-lib
  - delivery-lib
  - delivery-apps

#NOTE These variables may be moved to the project configuration instead of being here...
# Doing so could avoid a complete CI process when changing these variables.
variables:
  DELIVERY_DESTINATION: /var/local/ingescape/delivery
  DELIVERY_USER: i2
  DELIVERY_HOST: rafale

# Define ingescape library files
.build-lib-files: &build-lib-files
  only:
    changes:
      - .gitlab-ci.yml
      - src/**/*
      - CMakeLists.txt
      - builds/cmake/**/*
      - dependencies/yajl/**/*
      - dependencies/unix/*
      - dependencies/windows/unix/*
    refs:
      - master

# Define ingescape editor files
.build-editor-files: &build-editor-files
  only:
    changes:
      - .gitlab-ci.yml
      - src/**/*
      - builds/cmake/**/*
      - dependencies/yajl/**/*
      - dependencies/unix/*
      - dependencies/windows/unix/*
      - editor/frameworks/**/*
      - editor/apps/IngeScape-Common/**/*
      - editor/apps/IngeScape-Editor/**/*
    refs:
      - master

# Define ingescape assessments files
.build-assessments-files: &build-assessments-files
  only:
    changes:
      - .gitlab-ci.yml
      - src/**/*
      - builds/cmake/**/*
      - dependencies/yajl/**/*
      - dependencies/unix/*
      - dependencies/windows/unix/*
      - editor/frameworks/**/*
      - editor/apps/IngeScape-Common/**/*
      - editor/apps/IngeScape-Assessments/**/*
    refs:
      - master

# Create ingescape library for linux (x86_64)
lib-linux-release-x64:
  <<: *build-lib-files
  stage: build-lib
  tags:
    - docker
  image: ingescape/debian-with-zyre
  script:
    - git clean -xfd
    - mkdir build
    - cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
    - make -C build
  artifacts:
    paths:
      - build
    name: "lib-linux-release-x64"
    expire_in: 1 week
  dependencies: []
  
# Create ingescape library for linux (armv7/armhf)
lib-linux-release-armhf:
  <<: *build-lib-files
  stage: build-lib
  tags:
    - docker
  image: ingescape/ubuntu-x-compil-rpi
  script:
    - git clean -xfd
    - mkdir build
    - cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=/toolchain.cmake
    - make -C build
  artifacts:
    paths:
      - build
    name: "lib-linux-release-armhf"
    expire_in: 1 week
  dependencies: []

# Create ingescape library for macos
lib-macos-release-x64:
  <<: *build-lib-files
  stage: build-lib
  tags:
    - osx
  script:
    - git clean -xfd
    - mkdir build
    - cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
    - make -C build
  artifacts:
    paths:
      - build
    name: "lib-macos-release-x64"
    expire_in: 1 week
  dependencies: []

# Create ingescape editor for macos
editor-macos-release-x64:
  <<: *build-editor-files
  stage: build-apps
  variables:
    Qt5_DIR: ~/Qt/5.9.7/clang_64/lib/cmake/Qt5
  tags:
    - osx
  script:
    - git clean -xfd
    - mkdir editor/apps/IngeScape-Editor/build
    - cmake -S editor/apps/IngeScape-Editor/ -B editor/apps/IngeScape-Editor/build -DCMAKE_BUILD_TYPE=Release
    - make -C editor/apps/IngeScape-Editor/build
  artifacts:
    paths:
      - editor/apps/IngeScape-Editor/build
    name: "editor-macos-release-x64"
    expire_in: 1 week
  dependencies: []

# Create ingescape assessments for macos
assessments-macos-release-x64:
  <<: *build-assessments-files
  stage: build-apps
  variables:
    Qt5_DIR: ~/Qt/5.9.7/clang_64/lib/cmake/Qt5
  tags:
    - osx
  script:
    - git clean -xfd
    - mkdir editor/apps/IngeScape-Assessments/build
    - cmake -S editor/apps/IngeScape-Assessments/ -B editor/apps/IngeScape-Assessments/build -DCMAKE_BUILD_TYPE=Release
    - make -C editor/apps/IngeScape-Assessments/build
  artifacts:
    paths:
      - editor/apps/IngeScape-Assessments/build
    name: "assessments-macos-release-x64"
    expire_in: 1 week
  dependencies: []

# Create ingescape library for windows 64 bits release
lib-windows-release-x64:
  <<: *build-lib-files
  stage: build-lib
  tags:
    - windows
  variables:
    DEPENDENCIES_BUILDS_ROOT: "C:\\Users\\admin\\dev\\Builds"
  script:
    - set PATH=%PATH%;C:\Users\admin\dev\Builds\Release\x64;C:\Users\admin\dev\Builds
    - git clean -xfd
    - mkdir build\ReleaseX64
    - cmake -S . -B build\ReleaseX64 -G"Visual Studio 14 2015 Win64" -DCMAKE_BUILD_TYPE=Release
    - cmake --build build\ReleaseX64 --target ALL_BUILD --config Release
  artifacts:
    paths:
     - build
    name: "lib-windows-release-x64"
    expire_in: 1 week
  dependencies: []

# Create ingescape library for windows 32 bits release
lib-windows-release-x86:
  <<: *build-lib-files
  stage: build-lib
  tags:
    - windows
  variables:
    DEPENDENCIES_BUILDS_ROOT: "C:\\Users\\admin\\dev\\Builds"
  script:
    - set PATH=%PATH%;C:\Users\admin\dev\Builds\Release\x86;C:\Users\admin\dev\Builds
    - git clean -xfd
    - mkdir build\ReleaseX86
    - cmake -S . -B build\ReleaseX86 -G"Visual Studio 14 2015" -DCMAKE_BUILD_TYPE=Release
    - cmake --build build\ReleaseX86 --target ALL_BUILD --config Release
  artifacts:
    paths:
     - build
    name: "lib-windows-release-x86"
    expire_in: 1 week
  dependencies: []

# Create ingescape library for windows 64 bits debug
lib-windows-debug-x64:
  <<: *build-lib-files
  stage: build-lib
  tags:
    - windows
  variables:
    DEPENDENCIES_BUILDS_ROOT: "C:\\Users\\admin\\dev\\Builds"
  script:
    - set PATH=%PATH%;C:\Users\admin\dev\Builds\Debug\x64;C:\Users\admin\dev\Builds
    - git clean -xfd
    - mkdir build\DebugX64
    - cmake -S . -B build\DebugX64 -G"Visual Studio 14 2015 Win64" -DCMAKE_BUILD_TYPE=Debug
    - cmake --build build\DebugX64 --target ALL_BUILD --config Debug
  artifacts:
    paths:
     - build
    name: "lib-windows-debug-x64"
    expire_in: 1 week
  dependencies: []

# Create ingescape library for windows 32 bits debug
lib-windows-debug-x86:
  <<: *build-lib-files
  stage: build-lib
  tags:
    - windows
  variables:
    DEPENDENCIES_BUILDS_ROOT: "C:\\Users\\admin\\dev\\Builds"
  script:
    - set PATH=%PATH%;C:\Users\admin\dev\Builds\Debug\x86;C:\Users\admin\dev\Builds
    - git clean -xfd
    - mkdir build\DebugX86
    - cmake -S . -B build\DebugX86 -G"Visual Studio 14 2015" -DCMAKE_BUILD_TYPE=Debug
    - cmake --build build\DebugX86 --target ALL_BUILD --config Debug
  artifacts:
    paths:
     - build
    name: "lib-windows-debug-x86"
    expire_in: 1 week
  dependencies: []

# Create ingescape editor for windows
editor-windows-release-x86:
  <<: *build-editor-files
  stage: build-apps
  variables:
    DEPENDENCIES_BUILDS_ROOT: "C:\\Users\\admin\\dev\\Builds"
    Qt5_DIR: C:\\Users\\admin\\dev\\Qt\\5.9.7\\msvc2015\\lib\\cmake\\Qt5
  tags:
    - windows
  script:
    - set PATH=%PATH%;C:\Users\admin\dev\Builds\Release\x86;C:\Users\admin\dev\Builds
    - git clean -xfd
    - mkdir editor\apps\IngeScape-Editor\build\ReleaseX86
    - cmake editor\apps\IngeScape-Editor\ -B editor\apps\IngeScape-Editor\build\ReleaseX86 -G"Visual Studio 14 2015" -DCMAKE_BUILD_TYPE=Release
    - cmake --build editor\apps\IngeScape-Editor\build\ReleaseX86 --target ALL_BUILD --config Release
  artifacts:
    paths:
      - editor\apps\IngeScape-Editor\build
    name: "editor-windows-release-x86"
    expire_in: 1 week
  dependencies: []

# Create ingescape editor for windows
editor-windows-release-x64:
  <<: *build-editor-files
  stage: build-apps
  variables:
    DEPENDENCIES_BUILDS_ROOT: "C:\\Users\\admin\\dev\\Builds"
    Qt5_DIR: C:\\Users\\admin\\dev\\Qt\\5.9.7\\msvc2015_64\\lib\\cmake\\Qt5
  tags:
    - windows
  script:
    - set PATH=%PATH%;C:\Users\admin\dev\Builds\Release\x64;C:\Users\admin\dev\Builds
    - git clean -xfd
    - mkdir editor\apps\IngeScape-Editor\build\ReleaseX64
    - cmake editor\apps\IngeScape-Editor\ -B editor\apps\IngeScape-Editor\build\ReleaseX64 -G"Visual Studio 14 2015 Win64" -DCMAKE_BUILD_TYPE=Release
    - cmake --build editor\apps\IngeScape-Editor\build\ReleaseX64 --target ALL_BUILD --config Release
  artifacts:
    paths:
      - editor\apps\IngeScape-Editor\build
    name: "editor-windows-release-x64"
    expire_in: 1 week
  dependencies: []

# Create ingescape assessments for windows
assessments-windows-release-x86:
  <<: *build-assessments-files
  stage: build-apps
  variables:
    DEPENDENCIES_BUILDS_ROOT: "C:\\Users\\admin\\dev\\Builds"
    Qt5_DIR: C:\\Users\\admin\\dev\\Qt\\5.9.7\\msvc2015\\lib\\cmake\\Qt5
  tags:
    - windows
  script:
    - set PATH=%PATH%;C:\Users\admin\dev\Builds\Release\x86;C:\Users\admin\dev\Builds
    - git clean -xfd
    - mkdir editor\apps\IngeScape-Assessments\build\ReleaseX86
    - cmake editor\apps\IngeScape-Assessments\ -B editor\apps\IngeScape-Assessments\build\ReleaseX86 -G"Visual Studio 14 2015" -DCMAKE_BUILD_TYPE=Release
    - cmake --build editor\apps\IngeScape-Assessments\build\ReleaseX86 --target ALL_BUILD --config Release
  artifacts:
    paths:
      - editor\apps\IngeScape-Assessments\build
    name: "assessments-windows-release-x86"
    expire_in: 1 week
  dependencies: []

# Create ingescape assessments for windows
assessments-windows-release-x64:
  <<: *build-assessments-files
  stage: build-apps
  variables:
    DEPENDENCIES_BUILDS_ROOT: "C:\\Users\\admin\\dev\\Builds"
    Qt5_DIR: C:\\Users\\admin\\dev\\Qt\\5.9.7\\msvc2015_64\\lib\\cmake\\Qt5
  tags:
    - windows
  script:
    - set PATH=%PATH%;C:\Users\admin\dev\Builds\Release\x64;C:\Users\admin\dev\Builds
    - git clean -xfd
    - mkdir editor\apps\IngeScape-Assessments\build\ReleaseX64
    - cmake editor\apps\IngeScape-Assessments\ -B editor\apps\IngeScape-Assessments\build\ReleaseX64 -G"Visual Studio 14 2015 Win64" -DCMAKE_BUILD_TYPE=Release
    - cmake --build editor\apps\IngeScape-Assessments\build\ReleaseX64 --target ALL_BUILD --config Release
  artifacts:
    paths:
      - editor\apps\IngeScape-Assessments\build
    name: "assessments-windows-release-x64"
    expire_in: 1 week
  dependencies: []

# Create runtime install for windows 32 bits
lib-installer-runtime-windows-x86:
  <<: *build-lib-files
  stage: installer-lib
  tags:
    - windows
  script:
    - cd build\ReleaseX86 && cpack --config CPackConfig.cmake && cd ..\..
    - cd build\ReleaseX86 && cpack --config CPackSourceConfig.cmake && cd ..\..
  artifacts:
    paths:
      - build\ReleaseX86\ingescape-*.exe
      - build\ReleaseX86\ingescape-*.zip
    name: "lib-installer-runtime-windows-x86"
  dependencies:
    - lib-windows-release-x86

# Create runtime install for windows 64 bits
lib-installer-runtime-windows-x64:
  <<: *build-lib-files
  stage: installer-lib
  tags:
    - windows
  script:
    - cd build\ReleaseX64 && cpack --config CPackConfig.cmake && cd ..\..
    - cd build\ReleaseX64 && cpack --config CPackSourceConfig.cmake && cd ..\..
  artifacts:
    paths:
      - build\ReleaseX64\ingescape-*.exe
      - build\ReleaseX64\ingescape-*.zip
    name: "lib-installer-runtime-windows-x64"
  dependencies:
    - lib-windows-release-x64

# Create runtime install for macos 64 bits
lib-installer-runtime-macos-x64:
  <<: *build-lib-files
  stage: installer-lib
  tags:
    - osx
  script:
    - make -C build package
    - cp dependencies/unix/installIngescapeAndDependencies.sh build/installIngescapeAndDependencies.sh
    - sed -i '' 's/DARWIN_PACKAGE_FILE_NAME=.*/DARWIN_PACKAGE_FILE_NAME="'$(ls -l build/ | grep ingescape- | rev | cut -d' ' -f 1 | cut -d'.' -f2- | rev | uniq)'"/' build/installIngescapeAndDependencies.sh
    - mv build macos_x64
  artifacts:
    paths:
      - macos_x64/ingescape-*
      - macos_x64/installIngescapeAndDependencies.sh
    name: "lib-installer-runtime-macos-x64"
  dependencies:
    - lib-macos-release-x64

# Create editor install for macos 64 bits
editor-installer-macos-x64:
  <<: *build-editor-files
  stage: installer-apps
  tags:
    - osx
  script:
    - make -C editor/apps/IngeScape-Editor/build package
  #  - make -C editor/apps/IngeScape-Editor/build package_source
  artifacts:
    paths:
      - editor/apps/IngeScape-Editor/build/IngeScape-Editor-*
    name: "editor-installer-macos-x64"
  dependencies:
    - editor-macos-release-x64

# Create editor install for windows 32 bits
editor-installer-windows-x86:
  <<: *build-editor-files
  stage: installer-apps
  tags:
    - windows
  script:
    - cd editor\apps\IngeScape-Editor\build\ReleaseX86 && cpack --config CPackConfig.cmake && cd ..\..\..\..\..
  artifacts:
    paths:
      - editor\apps\IngeScape-Editor\build\ReleaseX86\IngeScape-Editor-*
    name: "editor-installer-windows-x86"
  dependencies:
    - editor-windows-release-x86

# Create editor install for windows 64 bits
editor-installer-windows-x64:
  <<: *build-editor-files
  stage: installer-apps
  tags:
    - windows
  script:
    - cd editor\apps\IngeScape-Editor\build\ReleaseX64 && cpack --config CPackConfig.cmake && cd ..\..\..\..\..
  artifacts:
    paths:
      - editor\apps\IngeScape-Editor\build\ReleaseX64\IngeScape-Editor-*
    name: "editor-installer-windows-x64"
  dependencies:
    - editor-windows-release-x64

# Create assessments install for macos 64 bits
assessments-installer-macos-x64:
  <<: *build-assessments-files
  stage: installer-apps
  tags:
    - osx
  script:
    - make -C editor/apps/IngeScape-Assessments/build package
  #  - make -C editor/apps/IngeScape-Assessments/build package_source
  artifacts:
    paths:
      - editor/apps/IngeScape-Assessments/build/IngeScape-Assessments-*
    name: "assessments-installer-macos-x64"
  dependencies:
    - assessments-macos-release-x64

# Create assessments install for windows 32 bits
assessments-installer-windows-x86:
  <<: *build-assessments-files
  stage: installer-apps
  tags:
    - windows
  script:
    - cd editor\apps\IngeScape-Assessments\build\ReleaseX86 && cpack --config CPackConfig.cmake && cd ..\..\..\..\..
  artifacts:
    paths:
      - editor\apps\IngeScape-Assessments\build\ReleaseX86\IngeScape-Assessments-*
    name: "assessments-installer-windows-x86"
  dependencies:
    - assessments-windows-release-x86

# Create assessments install for windows 64 bits
assessments-installer-windows-x64:
  <<: *build-assessments-files
  stage: installer-apps
  tags:
    - windows
  script:
    - cd editor\apps\IngeScape-Assessments\build\ReleaseX64 && cpack --config CPackConfig.cmake && cd ..\..\..\..\..
  artifacts:
    paths:
      - editor\apps\IngeScape-Assessments\build\ReleaseX64\IngeScape-Assessments-*
    name: "assessments-installer-windows-x64"
  dependencies:
    - assessments-windows-release-x64

# Create runtime install for linux 64 bits - Generic ZIP
lib-installer-runtime-linux-x64:
  <<: *build-lib-files
  stage: installer-lib
  tags:
    - docker
  image: ingescape/debian-with-zyre
  script:
    - make -C build package
    - cp dependencies/unix/installIngescapeAndDependencies.sh build/installIngescapeAndDependencies.sh
    - sed -i 's/LINUX_PACKAGE_FILE_NAME=.*/LINUX_PACKAGE_FILE_NAME="'$(ls -l build/ | grep ingescape- | rev | cut -d' ' -f 1 | cut -d'.' -f2- | rev | uniq)'"/' build/installIngescapeAndDependencies.sh
    - mv build linux_x64
  artifacts:
    paths:
      - linux_x64/ingescape-*
      - linux_x64/installIngescapeAndDependencies.sh
    name: "lib-installer-runtime-linux-x64"
  dependencies:
    - lib-linux-release-x64

# Create runtime install for linux 64 bits - Debian 9 (stretch)
lib-installer-runtime-debian-9-x64:
  <<: *build-lib-files
  stage: installer-lib
  tags:
    - docker
  image: ingescape/debian-with-zyre
  script:
    - cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DLINUX_FLAVOR="Debian 9 (stretch)"
    - make -C build package
    - cp dependencies/unix/installIngescapeAndDependencies.sh build/installIngescapeAndDependencies.sh
    - sed -i 's/LINUX_PACKAGE_FILE_NAME=.*/LINUX_PACKAGE_FILE_NAME="'$(ls -l build/ | grep ingescape- | rev | cut -d' ' -f 1 | cut -d'.' -f2- | rev | uniq)'"/' build/installIngescapeAndDependencies.sh
    - mv build debian9_x64
  artifacts:
    paths:
      - debian9_x64/ingescape-*
      - debian9_x64/installIngescapeAndDependencies.sh
    name: "lib-installer-runtime-debian-9-x64"
  dependencies:
    - lib-linux-release-x64

# Create runtime install for linux 64 bits - Debian 10 (buster)
lib-installer-runtime-debian-10-x64:
  <<: *build-lib-files
  stage: installer-lib
  tags:
    - docker
  image: ingescape/debian-with-zyre
  script:
    - cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DLINUX_FLAVOR="Debian 10 (buster)"
    - make -C build package
    - cp dependencies/unix/installIngescapeAndDependencies.sh build/installIngescapeAndDependencies.sh
    - sed -i 's/LINUX_PACKAGE_FILE_NAME=.*/LINUX_PACKAGE_FILE_NAME="'$(ls -l build/ | grep ingescape- | rev | cut -d' ' -f 1 | cut -d'.' -f2- | rev | uniq)'"/' build/installIngescapeAndDependencies.sh
    - mv build debian10_x64
  artifacts:
    paths:
      - debian10_x64/ingescape-*
      - debian10_x64/installIngescapeAndDependencies.sh
    name: "lib-installer-runtime-debian-10-x64"
  dependencies:
    - lib-linux-release-x64

# Create runtime install for linux 64 bits - CentOS
lib-installer-runtime-centos-x64:
  <<: *build-lib-files
  stage: installer-lib
  tags:
    - docker
  image: ingescape/debian-with-zyre
  script:
    - cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DLINUX_FLAVOR="CentOS"
    - make -C build package
    - cp dependencies/unix/installIngescapeAndDependencies.sh build/installIngescapeAndDependencies.sh
    - sed -i 's/LINUX_PACKAGE_FILE_NAME=.*/LINUX_PACKAGE_FILE_NAME="'$(ls -l build/ | grep ingescape- | rev | cut -d' ' -f 1 | cut -d'.' -f2- | rev | uniq)'"/' build/installIngescapeAndDependencies.sh
    - mv build centos7_x64
  artifacts:
    paths:
      - centos7_x64/ingescape-*
      - centos7_x64/installIngescapeAndDependencies.sh
    name: "lib-installer-runtime-centos-x64"
  dependencies:
    - lib-linux-release-x64

# Create runtime install for linux ARMv7 (armhf) - Generic ZIP
lib-installer-runtime-linux-armhf:
  <<: *build-lib-files
  stage: installer-lib
  tags:
    - docker
  image: ingescape/ubuntu-x-compil-rpi
  script:
    - make -C build package
    - cp dependencies/unix/installIngescapeAndDependencies.sh build/installIngescapeAndDependencies.sh
    - sed -i 's/LINUX_PACKAGE_FILE_NAME=.*/LINUX_PACKAGE_FILE_NAME="'$(ls -l build/ | grep ingescape- | rev | cut -d' ' -f 1 | cut -d'.' -f2- | rev | uniq)'"/' build/installIngescapeAndDependencies.sh
    - mv build linux_armhf
  artifacts:
    paths:
      - linux_armhf/ingescape-*
      - linux_armhf/installIngescapeAndDependencies.sh
    name: "lib-installer-runtime-linux-armhf"
  dependencies:
    - lib-linux-release-armhf

# Create runtime install for linux ARMv7 (armhf) - Raspbian 9 (stretch)
lib-installer-runtime-raspbian-9-armhf:
  <<: *build-lib-files
  stage: installer-lib
  tags:
    - docker
  image: ingescape/ubuntu-x-compil-rpi
  script:
    - cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DLINUX_FLAVOR="Raspbian 9 (stretch)"
    - make -C build package
    - cp dependencies/unix/installIngescapeAndDependencies.sh build/installIngescapeAndDependencies.sh
    - sed -i 's/LINUX_PACKAGE_FILE_NAME=.*/LINUX_PACKAGE_FILE_NAME="'$(ls -l build/ | grep ingescape- | rev | cut -d' ' -f 1 | cut -d'.' -f2- | rev | uniq)'"/' build/installIngescapeAndDependencies.sh
    - mv build raspbian9_armhf
  artifacts:
    paths:
      - raspbian9_armhf/ingescape-*
      - raspbian9_armhf/installIngescapeAndDependencies.sh
    name: "lib-installer-runtime-raspbian-9-armhf"
  dependencies:
    - lib-linux-release-armhf

# Deploy ingescape in mac os X to be able to compile agents
lib-deploy-macos-release-x64:
  <<: *build-lib-files
  stage: deploy-lib
  tags:
    - osx
  script:
    - make -C build install DESTDIR=~/builds/release/x64
    - cp src/include/ingescape_private.h ~/builds/release/x64/usr/local/include/ingescape/
  dependencies:
    - lib-macos-release-x64

# Deploy ingescape in linux to be able to compile agents
lib-deploy-linux-release-x64:
  <<: *build-lib-files
  stage: deploy-lib
  tags:
    - docker
  image: ingescape/debian-with-zyre
  script:
    - make -C build install DESTDIR=~/builds/release/x64
    - cp src/include/ingescape_private.h ~/builds/release/x64/usr/local/include/ingescape/
  dependencies:
    - lib-linux-release-x64

# Deploy ingescape in linux to be able to compile agents
lib-deploy-linux-release-armhf:
  <<: *build-lib-files
  stage: deploy-lib
  tags:
    - docker
  image: ingescape/ubuntu-x-compil-rpi
  script:
    - make -C build install DESTDIR=~/builds/release/armhf
    - cp src/include/ingescape_private.h ~/builds/release/armhf/usr/local/include/ingescape/
  dependencies:
    - lib-linux-release-armhf

# Deploy ingescape in windows to be able to compile agents
lib-deploy-windows-release-x64:
  <<: *build-lib-files
  stage: deploy-lib
  tags:
    - windows
  script:
    - copy /y src\include\*.h C:\Users\admin\dev\Builds\include\ingescape\
    - copy /y build\ReleaseX64\Release\* C:\Users\admin\dev\Builds\Release\x64\
  dependencies:
    - lib-windows-release-x64

# Deploy ingescape in windows to be able to compile agents
lib-deploy-windows-release-x86:
  <<: *build-lib-files
  stage: deploy-lib
  tags:
    - windows
  script:
    - copy /y src\include\*.h C:\Users\admin\dev\Builds\include\ingescape\
    - copy /y build\ReleaseX86\Release\* C:\Users\admin\dev\Builds\Release\x86\
  dependencies:
    - lib-windows-release-x86

# Deploy ingescape in windows to be able to compile agents
lib-deploy-windows-debug-x64:
  <<: *build-lib-files
  stage: deploy-lib
  tags:
    - windows
  script:
    - copy /y src\include\*.h C:\Users\admin\dev\Builds\include\ingescape\
    - copy /y build\DebugX64\Debug\* C:\Users\admin\dev\Builds\Debug\x64\
  dependencies:
    - lib-windows-debug-x64

# Deploy ingescape in windows to be able to compile agents
lib-deploy-windows-debug-x86:
  <<: *build-lib-files
  stage: deploy-lib
  tags:
    - windows
  script:
    - copy /y src\include\*.h C:\Users\admin\dev\Builds\include\ingescape\
    - copy /y build\DebugX86\Debug\* C:\Users\admin\dev\Builds\Debug\x86\
  dependencies:
    - lib-windows-debug-x86

# Deliver installers so they can be downloaded from the website
lib-delivery-all:
  <<: *build-lib-files
  stage: delivery-lib
  tags:
    - docker
  image: ingescape/debian-with-zyre
  script:
    - echo "Setting up SSH"
    - mkdir -p ~/.ssh/
    - echo ${SSH_KNOWN_HOSTS} | base64 -d >> ~/.ssh/known_hosts
    - umask 077
    - echo ${SSH_SECRET} | base64 -d > ssh_secret
    - umask 022
    - echo "Deliver Windows x86"
    - mkdir --parents library/win32
    - mv build/ReleaseX86/ingescape-*
         library/win32/
    - echo "Deliver Windows x64"
    - mkdir --parents library/win64
    - mv build/ReleaseX64/ingescape-*
         library/win64/
    - echo "Deliver MacOS x64"
    - mkdir --parents --parents library/macos
    - mv macos_x64/ingescape-*
         macos_x64/installIngescapeAndDependencies.sh
         library/macos/
    - echo "Deliver generic Linux x64"
    - mkdir --parents library/linux_x64/
    - mv linux_x64/ingescape-*
         linux_x64/installIngescapeAndDependencies.sh
         library/linux_x64/
    - echo "Deliver Debian 9 x64"
    - mkdir --parents library/debian9/
    - mv debian9_x64/ingescape-*
         debian9_x64/installIngescapeAndDependencies.sh
         library/debian9/
    - echo "Deliver Debian 10 x64"
    - mkdir --parents library/debian10/
    - mv debian10_x64/ingescape-*
         debian10_x64/installIngescapeAndDependencies.sh
         library/debian10/
    - echo "Deliver CentOS 7 x64"
    - mkdir --parents library/centos7
    - mv centos7_x64/ingescape-*
         centos7_x64/installIngescapeAndDependencies.sh
         library/centos7/
    - echo "Deliver generic Linux armhf"
    - mkdir --parents library/linux_armhf
    - mv linux_armhf/ingescape-*
         linux_armhf/installIngescapeAndDependencies.sh
         library/linux_armhf/
    - echo "Deliver Raspbian 9 armhf"
    - mkdir --parents library/raspbian9
    - mv raspbian9_armhf/ingescape-*
         raspbian9_armhf/installIngescapeAndDependencies.sh
         library/raspbian9/
    - echo "Synchronization"
    - rsync --rsh="ssh -i ssh_secret" --recursive --delete-after library ${DELIVERY_USER}@${DELIVERY_HOST}:${DELIVERY_DESTINATION}
  dependencies:
    - lib-installer-runtime-windows-x86
    - lib-installer-runtime-windows-x64
    - lib-installer-runtime-macos-x64
    - lib-installer-runtime-linux-x64
    - lib-installer-runtime-debian-9-x64
    - lib-installer-runtime-debian-10-x64
    - lib-installer-runtime-centos-x64
    - lib-installer-runtime-linux-armhf
    - lib-installer-runtime-raspbian-9-armhf

# Deliver installers so they can be downloaded from the website
apps-delivery-all:
  <<: *build-editor-files
  <<: *build-assessments-files
  stage: delivery-apps
  tags:
    - docker
  image: ingescape/debian-with-zyre
  script:
    - echo "Setting up SSH"
    - mkdir -p ~/.ssh/
    - echo ${SSH_KNOWN_HOSTS} | base64 -d >> ~/.ssh/known_hosts
    - umask 077
    - echo ${SSH_SECRET} | base64 -d > ssh_secret
    - umask 022
    - echo "Deliver Mac OS x64 editor"
    - mkdir --parents editor/macos
    - mv editor/apps/IngeScape-Editor/build/IngeScape-Editor-*
         editor/macos/
    - echo "Deliver Windows x86 editor"
    - mkdir --parents editor/win32
    - mv editor/apps/IngeScape-Editor/build/ReleaseX86/IngeScape-Editor-*
         editor/win32/
    - echo "Deliver Windows x64 editor"
    - mkdir --parents --parents editor/win64
    - mv editor/apps/IngeScape-Editor/build/ReleaseX64/IngeScape-Editor-*
         editor/win64/
    - echo "Deliver Mac OS x64 assessments"
    - mkdir --parents assessments/macos
    - mv editor/apps/IngeScape-Assessments/build/IngeScape-Assessments-*
         assessments/macos/
    - echo "Deliver Windows x86 assessments"
    - mkdir --parents editassessmentsor/win32
    - mv editor/apps/IngeScape-Assessments/build/ReleaseX86/IngeScape-Assessments-*
         assessments/win32/
    - echo "Deliver Windows x64 assessments"
    - mkdir --parents --parents assessments/win64
    - mv editor/apps/IngeScape-Assessments/build/ReleaseX64/IngeScape-Assessments-*
         assessments/win64/
    - echo "Synchronization"
    - rsync --rsh="ssh -i ssh_secret" --recursive --delete-after editor assessments ${DELIVERY_USER}@${DELIVERY_HOST}:${DELIVERY_DESTINATION}
  dependencies:
    - editor-installer-macos-x64
    - editor-installer-windows-x86
    - editor-installer-windows-x64
    - assessments-installer-macos-x64
    - assessments-installer-windows-x86
    - assessments-installer-windows-x64
