# Gitlab ci

# TODO Check why with install target windows api are in bin subfolder
# TODO Check why with compile target zmq, ... are not copied in Release folder on windows
# TODO Add yajl in unix and macos installer (or see to create yajl installer)
# TODO Add job to deploy ingescape website on commit (Can filter to launch job on doc folder changes and only master git's branche)
# TODO Add job to compile editor
# TODO Add job to compile ingeprobe
# TODO Add job to package bindings

# Define job order
stages:
  - build-lib
  - installer-lib
  - build-editor
  - installer-editor
  - deploy-lib

# Define ingescape library files
.build-lib-files: &build-lib-files
  only:
    changes:
      - src/**/*
      - CMakeLists.txt
      - builds/cmake/**/*
      - dependencies/windows/unix/*
    refs:
      - master

# Define ingescape editor files
.build-editor-files: &build-editor-files
  only:
    changes:
      - editor/**/*
    refs:
      - master

# Create ingescape library for linux
lib-linux-release-x64:
  <<: *build-lib-files
  stage: build-lib
  tags:
    - docker
  image: fafesty/debian-with-zyre
  script:
    - git clean -xfd
    - mkdir build
    - cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
    - make -C build
  artifacts:
    paths:
      - build
    name: "lib-linux-release-x64"
    expire_in: 1 week

# Create ingescape library for macos
lib-macos-release-x64:
  <<: *build-lib-files
  stage: build-lib
  tags:
    - osx
  script:
    - git clean -xfd
    - mkdir build
    - cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
    - make -C build
  artifacts:
    paths:
      - build
    name: "lib-macos-release-x64"
    expire_in: 1 week

# Create ingescape editor for macos
editor-macos-release-x64:
  <<: *build-editor-files
  stage: build-editor
  variables:
    Qt5_DIR: ~/Qt/5.9.7/clang_64/lib/cmake/Qt5
  tags:
    - osx
  script:
    - git clean -xfd
    - mkdir editor/apps/IngeScape-Editor/build
    - cmake -S editor/apps/IngeScape-Editor/ -B editor/apps/IngeScape-Editor/build -DCMAKE_BUILD_TYPE=Release
    - make -C editor/apps/IngeScape-Editor/build
  artifacts:
    paths:
      - editor/apps/IngeScape-Editor/build
    name: "editor-macos-release-x64"
    expire_in: 1 week

# Create ingescape library for windows 64 bits release
lib-windows-release-x64:
  <<: *build-lib-files
  stage: build-lib
  tags:
    - windows
  variables:
    DEPENDENCIES_BUILDS_ROOT: "C:\\Users\\admin\\dev\\Builds"
  script:
    - git clean -xfd
    - mkdir build\ReleaseX64
    - cmake -S . -B build\ReleaseX64 -G"Visual Studio 14 2015 Win64" -DCMAKE_BUILD_TYPE=Release -DLIBSODIUM_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Release\x64\libsodium.lib" -DLIBSODIUM_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include" -DLIBZMQ_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Release\x64\libzmq-v140-mt-4_3_1.lib" -DLIBZMQ_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include" -DCZMQ_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Release\x64\czmq.lib" -DCZMQ_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include" -DZYRE_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Release\x64\zyre.lib" -DZYRE_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include" -DYAJL_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Release\x64\yajl.lib" -DYAJL_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include"
    - cmake --build build\ReleaseX64 --target ALL_BUILD --config Release
  artifacts:
    paths:
     - build
    name: "lib-windows-release-x64"
    expire_in: 1 week

# Create ingescape library for windows 32 bits release
lib-windows-release-x86:
  <<: *build-lib-files
  stage: build-lib
  tags:
    - windows
  variables:
    DEPENDENCIES_BUILDS_ROOT: "C:\\Users\\admin\\dev\\Builds"
  script:
    - git clean -xfd
    - mkdir build\ReleaseX86
    - cmake -S . -B build\ReleaseX86 -G"Visual Studio 14 2015" -DCMAKE_BUILD_TYPE=Release -DLIBSODIUM_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Release\x86\libsodium.lib" -DLIBSODIUM_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include" -DLIBZMQ_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Release\x86\libzmq-v140-mt-4_3_1.lib" -DLIBZMQ_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include" -DCZMQ_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Release\x86\czmq.lib" -DCZMQ_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include" -DZYRE_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Release\x86\zyre.lib" -DZYRE_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include" -DYAJL_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Release\x86\yajl.lib" -DYAJL_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include"
    - cmake --build build\ReleaseX86 --target ALL_BUILD --config Release
  artifacts:
    paths:
     - build
    name: "lib-windows-release-x86"
    expire_in: 1 week

# Create ingescape library for windows 64 bits debug
lib-windows-debug-x64:
  <<: *build-lib-files
  stage: build-lib
  tags:
    - windows
  variables:
    DEPENDENCIES_BUILDS_ROOT: "C:\\Users\\admin\\dev\\Builds"
  script:
    - git clean -xfd
    - mkdir build\DebugX64
    - cmake -S . -B build\DebugX64 -G"Visual Studio 14 2015 Win64" -DCMAKE_BUILD_TYPE=Debug -DLIBSODIUM_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Debug\x64\libsodium.lib" -DLIBSODIUM_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include" -DLIBZMQ_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Debug\x64\libzmq-v140-mt-gd-4_3_1.lib" -DLIBZMQ_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include" -DCZMQ_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Debug\x64\czmq.lib" -DCZMQ_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include" -DZYRE_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Debug\x64\zyre.lib" -DZYRE_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include" -DYAJL_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Debug\x64\yajl.lib" -DYAJL_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include"
    - cmake --build build\DebugX64 --target ALL_BUILD --config Debug
  artifacts:
    paths:
     - build
    name: "lib-windows-debug-x64"
    expire_in: 1 week

# Create ingescape library for windows 32 bits debug
lib-windows-debug-x86:
  <<: *build-lib-files
  stage: build-lib
  tags:
    - windows
  variables:
    DEPENDENCIES_BUILDS_ROOT: "C:\\Users\\admin\\dev\\Builds"
  script:
    - git clean -xfd
    - mkdir build\DebugX86
    - cmake -S . -B build\DebugX86 -G"Visual Studio 14 2015" -DCMAKE_BUILD_TYPE=Debug -DLIBSODIUM_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Debug\x86\libsodium.lib" -DLIBSODIUM_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include" -DLIBZMQ_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Debug\x86\libzmq-v140-mt-gd-4_3_1.lib" -DLIBZMQ_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include" -DCZMQ_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Debug\x86\czmq.lib" -DCZMQ_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include" -DZYRE_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Debug\x86\zyre.lib" -DZYRE_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include" -DYAJL_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Debug\x86\yajl.lib" -DYAJL_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include"
    - cmake --build build\DebugX86 --target ALL_BUILD --config Debug
  artifacts:
    paths:
     - build
    name: "lib-windows-debug-x86"
    expire_in: 1 week

# Create ingescape editor for windows
editor-windows-release-x86:
  <<: *build-editor-files
  stage: build-editor
  variables:
    DEPENDENCIES_BUILDS_ROOT: "C:\\Users\\admin\\dev\\Builds"
    Qt5_DIR: C:\\Users\\admin\\dev\\Qt\\5.9.7\\msvc2015\\lib\\cmake\\Qt5
  tags:
    - windows
  script:
    - git clean -xfd
    - mkdir editor\apps\IngeScape-Editor\build\ReleaseX86
    - cmake editor\apps\IngeScape-Editor\ -B editor\apps\IngeScape-Editor\build\ReleaseX86 -G"Visual Studio 14 2015" -DCMAKE_BUILD_TYPE=Release -DLIBSODIUM_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Release\x86\libsodium.lib" -DLIBSODIUM_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include" -DLIBZMQ_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Release\x86\libzmq-v140-mt-4_3_1.lib" -DLIBZMQ_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include" -DCZMQ_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Release\x86\czmq.lib" -DCZMQ_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include" -DZYRE_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Release\x86\zyre.lib" -DZYRE_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include" -DYAJL_LIBRARIES="%DEPENDENCIES_BUILDS_ROOT%\Release\x86\yajl.lib" -DYAJL_INCLUDE_DIRS="%DEPENDENCIES_BUILDS_ROOT%\include"
    - cmake --build editor\apps\IngeScape-Editor\build\ReleaseX86 --target ALL_BUILD --config Release
  artifacts:
    paths:
      - editor\apps\IngeScape-Editor\build
    name: "editor-windows-release-x86"
    expire_in: 1 week

# Create runtime install for windows 32 bits
lib-installer-runtime-windows-x86:
  <<: *build-lib-files
  stage: installer-lib
  tags:
    - windows
  script:
    - cd build\ReleaseX86 && cpack --config CPackConfig.cmake && cd ..\..
    - cd build\ReleaseX86 && cpack --config CPackSourceConfig.cmake && cd ..\..
  artifacts:
    paths:
      - build\ReleaseX86\ingescape-*.exe
      - build\ReleaseX86\ingescape-*.zip
  dependencies:
    - lib-windows-release-x86

# Create runtime install for windows 64 bits
lib-installer-runtime-windows-x64:
  <<: *build-lib-files
  stage: installer-lib
  tags:
    - windows
  script:
    - cd build\ReleaseX64 && cpack --config CPackConfig.cmake && cd ..\..
    - cd build\ReleaseX64 && cpack --config CPackSourceConfig.cmake && cd ..\..
  artifacts:
    paths:
      - build\ReleaseX64\ingescape-*.exe
      - build\ReleaseX64\ingescape-*.zip
  dependencies:
    - lib-windows-release-x64

# Create runtime install for macos 64 bits
lib-installer-runtime-macos-x64:
  <<: *build-lib-files
  stage: installer-lib
  tags:
    - osx
  script:
    - make -C build package
  artifacts:
    paths:
      - build/ingescape-*
  dependencies:
    - lib-macos-release-x64

# Create editor install for macos 64 bits
editor-installer-macos-x64:
  <<: *build-editor-files
  stage: installer-editor
  tags:
    - osx
  script:
    - make -C editor/apps/IngeScape-Editor/build package
  #  - make -C editor/apps/IngeScape-Editor/build package_source
  artifacts:
    paths:
      - editor/apps/IngeScape-Editor/build/IngeScape-Editor-*
  dependencies:
    - editor-macos-release-x64

# Create editor install for windows 32 bits
editor-installer-windows-x86:
  <<: *build-editor-files
  stage: installer-editor
  tags:
    - windows
  script:
    - cd editor\apps\IngeScape-Editor\build\ReleaseX86 && cpack --config CPackConfig.cmake && cd ..\..\..\..\..
  artifacts:
    paths:
      - editor\apps\IngeScape-Editor\build\ReleaseX86\IngeScape-Editor-*
  dependencies:
    - editor-windows-release-x86

# Create runtime install for linux 64 bits
lib-installer-runtime-linux-x64:
  <<: *build-lib-files
  stage: installer-lib
  tags:
    - docker
  image: fafesty/debian-with-zyre
  script:
    - make -C build package
  artifacts:
    paths:
      - build/ingescape-*
  dependencies:
    - lib-linux-release-x64

# Deploy ingescape in mac os X use to compile to be able to compile agents
lib-deploy-macos-release-x64:
  <<: *build-lib-files
  stage: deploy-lib
  tags:
    - osx
  script:
    - make -C build install DESTDIR=~/builds/release/x64
    - cp src/include/ingescape_private.h ~/builds/release/x64/usr/local/include/ingescape/
  dependencies:
    - lib-macos-release-x64

# Deploy ingescape in linux use to compile to be able to compile agents
lib-deploy-linux-release-x64:
  <<: *build-lib-files
  stage: deploy-lib
  tags:
    - docker
  image: fafesty/debian-with-zyre
  script:
    - make -C build install DESTDIR=~/builds/release/x64
    - cp src/include/ingescape_private.h ~/builds/release/x64/usr/local/include/ingescape/
  dependencies:
    - lib-linux-release-x64
