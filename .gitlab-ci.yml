image: fafesty/compile-with-zyre

stages:
  - linux
  - cross
  - headers

linux-x86:
  stage: linux
  script:
    - cd $CI_PROJECT_DIR
    - git clean -xfd
    - ./autogen.sh
    - ./configure
    - make
    - mkdir linux-x86
    - cp src/libingescape.la src/.libs/libingescape.a src/.libs/libingescape.so src/.libs/libingescape.so.0 src/.libs/libingescape.so.0.8.1 linux-x86/
  only:
   - autotool
  artifacts:
    paths:
      - linux-x86

win32-x86:
  stage: cross
  script:
    - cd $CI_PROJECT_DIR
    - git clean -xfd
    - ./autogen.sh
    - ./configure --prefix=/usr/x86_64-w64-mingw32 --exec-prefix=/usr/x86_64-w64-mingw32 --build=x86_64-pc-linux-gnu --host=x86_64-w64-mingw32 LDFLAGS="-L/usr/x86_64-w64-mingw32/lib" PKG_CONFIG_LIBDIR=/usr/x86_64-w64-mingw32/lib/pkgconfig
    - make
    - mkdir win32-x86
    - cp src/libingescape.def src/.libs/libingescape.a src/.libs/libingescape.dll src/.libs/libingescape.dll.a win32-x86/
    - cp /usr/lib/gcc/x86_64-w64-mingw32/6.3-win32/libstdc++-6.dll /usr/lib/gcc/x86_64-w64-mingw32/6.3-win32/libgcc_s_seh-1.dll   win32-x86/
    - cp /usr/x86_64-w64-mingw32/bin/libzyre.dll /usr/x86_64-w64-mingw32/bin/libczmq.dll /usr/x86_64-w64-mingw32/bin/libzmq.dll /usr/x86_64-w64-mingw32/bin/libsodium-23.dll /usr/x86_64-w64-mingw32/bin/libyajl.dll  win32-x86/
  only:
    - autotool
  artifacts:
    paths:
     - win32-x86

win32-i686:
  stage: cross
  script:
    - cd $CI_PROJECT_DIR
    - git clean -xfd
    - ./autogen.sh
    - ./configure --prefix=/usr/i686-w64-mingw32 --exec-prefix=/usr/i686-w64-mingw32 --build=x86_64-pc-linux-gnu --host=i686-w64-mingw32 LDFLAGS="-L/usr/i686-w64-mingw32/lib" PKG_CONFIG_LIBDIR=/usr/i686-w64-mingw32/lib/pkgconfig
    - make
    - mkdir win32-i686
    - cp src/libingescape.def src/.libs/libingescape.a src/.libs/libingescape.dll src/.libs/libingescape.dll.a win32-i686/
    - cp /usr/lib/gcc/i686-w64-mingw32/6.3-win32/libstdc++-6.dll /usr/lib/gcc/i686-w64-mingw32/6.3-win32/libgcc_s_sjlj-1.dll win32-i686/
    - cp /usr/i686-w64-mingw32/bin/libzyre.dll /usr/i686-w64-mingw32/bin/libczmq.dll /usr/i686-w64-mingw32/bin/libzmq.dll /usr/i686-w64-mingw32/bin/libsodium-23.dll /usr/i686-w64-mingw32/bin/libyajl.dll  win32-i686/
  only:
    - autotool
  artifacts:
    paths:
     - win32-i686

includes:
  stage: headers
  script:
   - cd $CI_PROJECT_DIR
   - mkdir -p include/ingescape
   - cp src/include/ingescape.h src/include/ingescape_advanced.h include/ingescape/
  only:
   - autotool
  artifacts:
    paths:
      - include
